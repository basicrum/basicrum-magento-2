<?php
declare(strict_types=1);

use BasicRum\Analytics\ViewModel\Footer;
use Magento\Framework\Escaper;
use Magento\Framework\View\Element\Template;
use Magento\Framework\View\Helper\SecureHtmlRenderer;

/** @var Template $block */
/** @var Footer $viewModel */
/** @var SecureHtmlRenderer $secureRenderer */
/** @var Escaper $escaper */

$viewModel = $block->getViewModel();
$config = $viewModel->getConfig();
$pageType = $viewModel->getPageType();

$scriptString = <<<script
(function(w) {
    var WAIT_AFTER_ONLOAD_MILLISECONDS = 5000;

    if (!w) {
        return;
    }

    w.BOOMR_mq = window.BOOMR_mq || [];

    w.BOOMR_mq.push(
        ["addVar", "p_type", "{$block->escapeJs($pageType)}"],
        ["addVar", "p_gen", "mage2"]
    );

    BOOMR = w.BOOMR || {};
    BOOMR.plugins = BOOMR.plugins || {};

    BOOMR.plugins.WaitAfterOnload = {
        complete: false,

        init: function() {
            BOOMR.subscribe("page_ready", function() {
                setTimeout(function() {
                    this.complete = true;
                    BOOMR.sendBeacon();
                }.bind(this), WAIT_AFTER_ONLOAD_MILLISECONDS);
            }, {}, this);
        },

        is_complete: function() {
            return this.complete;
        }
    };

    w.basicRumBoomerangConfig = {
        beacon_url: "{$block->escapeJs($config['beacon_endpoint'])}",
        instrument_xhr: true,
        Continuity: {
            enabled: true
        },
        ResourceTiming: {
            "enabled": true,
            "splitAtPath": true
        },
        secure_cookie: true,
        same_site_cookie: "Strict"
    }
})(window);
(function(d, s) {
  var js = d.createElement(s),
      sc = d.getElementsByTagName(s)[0];

  js.src="{$escaper->escapeJs($block->getViewFileUrl('BasicRum_Analytics::js/boomr/boomerang-1.815.60.cutting-edge.min.js'))}";
  sc.parentNode.insertBefore(js, sc);
}(document, "script"));
script;
?>
<?= /* @noEscape */ $secureRenderer->renderTag('script', [], $scriptString, false) ?>
